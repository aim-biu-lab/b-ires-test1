# MongoDB Authentication Fix

## Problem Summary

The backend was failing to start during installation with this error:
```
pymongo.errors.OperationFailure: Command createIndexes requires authentication
```

## Root Cause

In production mode (`docker-compose.prod.yml`), MongoDB and Redis are configured with authentication:
- MongoDB requires username/password
- Redis requires a password

However, the health check scripts were not using authentication, and the backend container wasn't properly picking up the authenticated connection strings from the `.env` file.

## Fixes Applied

### 1. **Module 07: Deploy App** (`scripts/installer/modules/07-deploy-app.sh`)

#### Fixed MongoDB Health Check
- Added authentication for production mode MongoDB health checks
- Health check now uses: `mongosh -u admin -p ${mongo_admin_password} --authenticationDatabase admin`
- Test mode continues to work without authentication

#### Fixed Redis Health Check  
- Added password authentication for production mode Redis health checks
- Health check now uses: `redis-cli -a ${redis_password} ping`
- Test mode continues to work without authentication

#### Added Container Recreation
- Added `docker compose down` before starting infrastructure to clear old containers
- Added `--force-recreate` flag to ensure containers pick up new `.env` values
- This prevents containers from running with stale environment variables

#### Added .env Verification
- Added check to verify `.env` file exists before starting services
- Added check to verify `MONGO_URL` is present in `.env`

#### Enhanced Error Diagnostics
- Added display of backend container environment variables (with redacted passwords)
- Added comparison between `.env` file and container environment
- This helps debug cases where environment variables aren't being loaded

### 2. **Module 08: Admin User Setup** (`scripts/installer/modules/08-admin-user.sh`)

#### Fixed All MongoDB Operations
Updated three functions to use authentication in production mode:

1. **`do_create_admin_via_mongodb`**
   - Creates admin user in MongoDB
   - Now uses authenticated mongosh connection in production

2. **`do_disable_default_admin`**
   - Disables default admin account
   - Now uses authenticated mongosh connection in production

3. **`do_verify_admin`**
   - Verifies admin user exists in database
   - Now uses authenticated mongosh connection in production

All functions now:
- Load `.env` file to get `MONGO_ADMIN_PASSWORD`
- Build appropriate `mongosh_cmd` based on mode (production vs test)
- Use authenticated connection string in production mode

### 3. **Library: Common Functions** (`scripts/installer/lib/common.sh`)

#### Fixed `wait_for_mongodb` Function
- Added authentication for production mode
- Loads `.env` file to get credentials
- Uses authenticated mongosh command: `mongosh -u admin -p ${mongo_admin_password} --authenticationDatabase admin`
- Test mode continues without authentication

## Authentication Pattern

### Production Mode Connection String
```bash
# MongoDB
mongosh -u admin -p ${mongo_admin_password} --authenticationDatabase admin bires

# Redis  
redis-cli -a ${redis_password} ping
```

### Test Mode Connection String
```bash
# MongoDB
mongosh bires

# Redis
redis-cli ping
```

## Files Modified

1. `scripts/installer/modules/07-deploy-app.sh`
   - Lines 186-266: `do_start_infrastructure()` function
   - Lines 238-270: `do_start_application()` function  
   - Lines 267-305: Backend startup error diagnostics

2. `scripts/installer/modules/08-admin-user.sh`
   - Lines 106-197: `do_create_admin_via_mongodb()` function
   - Lines 190-250: `do_disable_default_admin()` function
   - Lines 274-307: `do_verify_admin()` function

3. `scripts/installer/lib/common.sh`
   - Lines 676-745: `wait_for_mongodb()` function

## Testing Recommendations

After these fixes, test the installation by:

1. **Clean Install Test**
   ```bash
   # On the server, remove old containers and volumes
   cd /home/bires/bires
   docker compose -f docker-compose.yml -f docker-compose.prod.yml down -v
   
   # Re-run the installer
   bash /tmp/bires-installer/bires-setup.sh
   ```

2. **Verify Backend Starts**
   - Backend should start within 30-60 seconds
   - Check logs: `docker compose logs backend`
   - Should see: "Application startup complete"

3. **Verify Admin User Creation**
   - Module 08 should complete successfully
   - Test login at the admin panel

## Environment File Format

The `.env` file should contain (generated by Module 04):
```bash
# MongoDB with authentication
MONGO_URL=mongodb://bires_admin:PASSWORD@mongo:27017/bires?authSource=admin
MONGO_ADMIN_PASSWORD=ADMIN_PASSWORD
MONGO_USER=bires_admin
MONGO_PASSWORD=PASSWORD

# Redis with authentication  
REDIS_URL=redis://:PASSWORD@redis:6379
REDIS_PASSWORD=PASSWORD
```

## Backwards Compatibility

These fixes maintain backwards compatibility:
- Test mode (without SSL) continues to work without authentication
- Development mode continues to work without authentication
- Only production mode uses authentication
